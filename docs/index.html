<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bonnie-engine :: PS1 Software Rasterizer</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #1a1a2e;
        }
        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            outline: none;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #eee;
            font-family: monospace;
            font-size: 18px;
            z-index: 10;
        }
    </style>
</head>
<body>
    <canvas id="glcanvas" tabindex="1"></canvas>
    <script src="mq_js_bundle.js"></script>
    <script>
        document.getElementById('glcanvas').addEventListener('contextmenu', e => e.preventDefault());

        // Bonnie engine file import/export functions
        // These use native browser localStorage directly

        // Import: open file picker and store result in localStorage for Rust to read
        window.bonnie_import_file = function() {
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = '.ron';
            input.onchange = function(e) {
                var file = e.target.files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        localStorage.setItem('_bonnie_import_data', e.target.result);
                        localStorage.setItem('_bonnie_import_filename', file.name);
                        localStorage.setItem('_bonnie_import_ready', 'true');
                        console.log('Import: file loaded into localStorage:', file.name);
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        };

        // Download: receive data from Rust via sapp-jsutils JsObject and trigger download
        window.bonnie_download = function(data_handle, filename_handle) {
            // sapp-jsutils passes handles to JS objects stored in wasm_exports.js_objects
            var data = wasm_exports.js_objects[data_handle];
            var filename = wasm_exports.js_objects[filename_handle];
            console.log('bonnie_download called, data length:', data ? data.length : 0, 'filename:', filename);

            if (data && filename) {
                var blob = new Blob([data], {type: 'text/plain'});
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        };

        // Check if import is ready
        // Returns 1 if import ready, 0 if not
        window.bonnie_check_import = function() {
            var ready = localStorage.getItem('_bonnie_import_ready');
            return ready === 'true' ? 1 : 0;
        };

        // Get the imported data string (call after check returns 1)
        window.bonnie_get_import_data = function() {
            var data = localStorage.getItem('_bonnie_import_data') || '';
            return data;
        };

        // Get the imported filename string (call after check returns 1)
        window.bonnie_get_import_filename = function() {
            var filename = localStorage.getItem('_bonnie_import_filename') || 'imported.ron';
            return filename;
        };

        // Clear the import data (call after successfully reading)
        window.bonnie_clear_import = function() {
            localStorage.removeItem('_bonnie_import_ready');
            localStorage.removeItem('_bonnie_import_data');
            localStorage.removeItem('_bonnie_import_filename');
            console.log('bonnie_clear_import: cleared import data');
        };

        // Register as WASM imports so Rust can call them
        miniquad_add_plugin({
            register_plugin: function(importObject) {
                importObject.env.bonnie_import_file = window.bonnie_import_file;
                importObject.env.bonnie_download = window.bonnie_download;
                importObject.env.bonnie_check_import = window.bonnie_check_import;
                importObject.env.bonnie_get_import_data = window.bonnie_get_import_data;
                importObject.env.bonnie_get_import_filename = window.bonnie_get_import_filename;
                importObject.env.bonnie_clear_import = window.bonnie_clear_import;
            }
        });

        load("bonnie-rs.wasm");
    </script>
</body>
</html>
